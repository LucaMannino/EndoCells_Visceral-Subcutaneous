---
title: "Untitled3"
output: html_document
---

Load Packages
```{r}  
library(Seurat)
library(magrittr) 
library(dplyr) 
```
Load Data. This data contains only Endothelial cells. These have been selected from a larger object. 


Samples include Lean, Obese and Unhealthy Obese this is "condition"
```{r}  
endo_cells <- readRDS(file ="/home/lucamannino/R_Projects/Intagration_endoCellAtlas/endo_cells.RDS")
```

We build a new UMAP plot to look at the data
We use the integrated assay for this step
```{r} 
DefaultAssay(endo_cells) <- "integrated"

endo_cells <- FindNeighbors(endo_cells, dims = 1:25)
endo_cells <- RunUMAP(endo_cells, dims = 1:25)
endo_cells <- FindClusters(endo_cells, resolution = 0.8)
```
There are several patients included in this study, the patients labels are recorded under endo_cells@meta.data[["orig.ident"]].

Patients have been categorized by their condition: Obese, Unhelthy Obese and Lean (endo_cells@meta.data[["condition"]]).

From each patient subcutaneous and visceral cells were analysed, which cells belong to which tissue is recorded under endo_cells@meta.data[["type"]]

```{r}
DimPlot(endo_cells, label=TRUE, group.by = "type")
DimPlot(endo_cells, label=TRUE, group.by = "condition")
DimPlot(endo_cells, label=TRUE, group.by = "orig.ident")

```

In the following plot we look at specific markers to further clean the object from non endothelial cells
For this we use the SCT assay
```{r}  

DefaultAssay(endo_cells) <- "SCT"
FeaturePlot(endo_cells, c("PECAM1","CDH5","CLU","VWF"))

DotPlot(endo_cells, features = c("PECAM1","CDH5","CLU","VWF"), assay="SCT")
DotPlot(endo_cells, features = c("FLRT2","ACSL4","COL8A1","CACNB2"), assay="SCT")
```
There are several patients included in this study, the patients labels are recorded under endo_cells@meta.data[["orig.ident"]].

Patients have been categorized by their condition: Obese, Unhelthy Obese and Lean (endo_cells@meta.data[["condition"]]).

From each patient subcutaneous and visceral cells were analysed, which cells belong to which tissue is recorded under endo_cells@meta.data[["type"]]

```{r}
DimPlot(endo_cells, label=TRUE, group.by = "type")
DimPlot(endo_cells, label=TRUE, group.by = "condition")
DimPlot(endo_cells, label=TRUE, group.by = "orig.ident")

```

we remove clusters 0,1,2,13 as they are not endothelial

```{r}
EndoCells1 <- subset(endo_cells, idents = c(3,4,5,6,7,8,9,10,11,12,14))
```


New Umap plot is produced
```{r}

DefaultAssay(EndoCells1) <- "integrated"

EndoCells1 <- FindNeighbors(EndoCells1, dims = 1:20)
EndoCells1 <- RunUMAP(EndoCells1, dims = 1:20)
EndoCells1 <- FindClusters(EndoCells1, resolution = 3.5)
```


Check for immune cells
```{r}
DefaultAssay(EndoCells1) <- "integrated"
EndoCells1 <- FindClusters(EndoCells1, resolution = 1.0)
DefaultAssay(EndoCells1) <- "SCT"

FeaturePlot(EndoCells1,  c("CD163","MRC1","PTPRC"), pt.size = 0.1,reduction ="umap",min.cutoff=0)
FeaturePlot(EndoCells1,  c("CDH5","PECAM1","LYVE1","PROX1"), pt.size = 0.1,reduction ="umap",min.cutoff=0)



DimPlot(EndoCells1, label=TRUE)
DotPlot(EndoCells1,features = c("CD163","MRC1","PTPRC","CDH5","PECAM1","LYVE1","PROX1"), assay = "SCT",cols = c("blue", "red"))
```
```{r}
DimPlot(EndoCells1, label=TRUE, group.by = "type")
DimPlot(EndoCells1, label=TRUE, group.by = "condition")
DimPlot(EndoCells1, label=TRUE, group.by = "orig.ident")

```
removing clusters 7 and 8 and 14
```{r}
EndoCells2 <- subset(EndoCells1, idents = c(0,1,2,3,4,5,6,9,10,11,12,13))
```

In this step we decided to carry out a new SCT transform and a new integration in order to obtain better results. As we have removed a lot of cells from the original SCT and integration assay it is usefull to run the integration and the normalisation again.


To acheve this we split the object in its original samples, run SCT transform on the "SOUP" assay. We will then integrate the object by sample.
```{r}
EndoCells2.list <- SplitObject(EndoCells2, split.by = "orig.ident")

for (i in 1:length(EndoCells2.list)) {
    EndoCells2.list[[i]] <- SCTransform(EndoCells2.list[[i]], assay = "soup", variable.features.n = 3000, verbose = FALSE)
}

```


need to use:
options(future.globals.maxSize = 2500 * 1024^2) in order to increase the maximum allowed size for the integration algorithm
```{r}
options(future.globals.maxSize = 2500 * 1024^2)
EndoCells2.list.features <- SelectIntegrationFeatures(object.list = EndoCells2.list, nfeatures = 3000)
EndoCells2.list <- PrepSCTIntegration(object.list = EndoCells2.list, anchor.features = EndoCells2.list.features, 
    verbose = FALSE)

```


```{r}
options(future.globals.maxSize = 2500 * 1024^2)
EndoCells2.list.anchors <- FindIntegrationAnchors(object.list = EndoCells2.list, normalization.method = "SCT", 
    anchor.features = EndoCells2.list.features, verbose = FALSE)
EndoCells2.list.integrated <- IntegrateData(anchorset = EndoCells2.list.anchors, normalization.method = "SCT", 
    verbose = FALSE)

```
We produce a new UMAP plot from the integrated data

```{r}


DefaultAssay(EndoCells2.list.integrated) <- "integrated"
EndoCells2.list.integrated <- RunPCA(EndoCells2.list.integrated, npcs = 40, verbose = FALSE)
EndoCells2.list.integrated <- FindNeighbors(EndoCells2.list.integrated, dims = 1:20)
EndoCells2.list.integrated <- RunUMAP(EndoCells2.list.integrated, dims = 1:20)
EndoCells2.list.integrated <- FindClusters(EndoCells2.list.integrated, resolution = 0.30)

```
QC the new object

```{r}

DefaultAssay(EndoCells2.list.integrated) <- "SCT"

DimPlot(EndoCells2.list.integrated, label=TRUE, group.by = "type")
DimPlot(EndoCells2.list.integrated, label=TRUE, group.by = "condition")
DimPlot(EndoCells2.list.integrated, label=TRUE, group.by = "orig.ident")

```


QC checks to see if we have any non endothelial cells left
```{r}
DefaultAssay(EndoCells2.list.integrated) <- "SCT"
FeaturePlot(EndoCells2.list.integrated,  c("CD163","MRC1","PTPRC"), pt.size = 0.1,reduction ="umap",min.cutoff=0)
FeaturePlot(EndoCells2.list.integrated,  c("CDH5","PECAM1","LYVE1","PROX1"), pt.size = 0.1,reduction ="umap",min.cutoff=0)
FeaturePlot(EndoCells2.list.integrated,  c("CDH5"), pt.size = 0.1,reduction ="umap",min.cutoff=0)

DimPlot(EndoCells2.list.integrated, label=TRUE)
DotPlot(EndoCells2.list.integrated,features = c("CD163","MRC1","PTPRC","CDH5","PECAM1", "VCAM1", "LYVE1","PROX1"), assay = "SCT",cols = c("blue", "red"))
```



We remove cluster 3 from the object

```{r}
Strict2 <- subset(EndoCells2.list.integrated, idents = c(0,1,2,4,5,6,7))
```


```{r}
DefaultAssay(Strict2) <- "integrated"
Strict2 <- FindNeighbors(Strict2, dims = 1:20)
Strict2 <- RunUMAP(Strict2, dims = 1:20)
Strict2 <- FindClusters(Strict2, resolution = 0.5)

```





```{r}
DefaultAssay(Strict2) <- "SCT"

DimPlot(Strict2, label=TRUE, group.by = "type")
DimPlot(Strict2, label=TRUE, group.by = "condition")
DimPlot(Strict2, label=TRUE, group.by = "orig.ident")
DimPlot(Strict2, label=TRUE)
DimPlot(Strict2, label=TRUE, split.by = "type")
FeaturePlot(Strict2, c("PROX1"), pt.size = 0.1,reduction ="umap",min.cutoff=0, split.by ="type" )
```



```{r}

FeaturePlot(Strict2,  c("CD163","MRC1","PTPRC"), pt.size = 0.1,reduction ="umap",min.cutoff=0)
FeaturePlot(Strict2,  c("CDH5","PECAM1","LYVE1","PROX1"), pt.size = 0.1,reduction ="umap",min.cutoff=0)
FeaturePlot(Strict2,  c("CDH5"), pt.size = 0.1,reduction ="umap",min.cutoff=0)

DimPlot(Strict2, label=TRUE)
DotPlot(Strict2,features = c("CD163","MRC1","PTPRC","CDH5","PECAM1","LYVE1","PROX1"), assay = "SCT",cols = c("blue", "red"))
```




To label the endothelial subclusters we use Find all marker function, and then use this marker genes to appropiately label subclusters
```{r}
combined.sct <- PrepSCTFindMarkers(Strict2)

combined.markers <- FindAllMarkers(combined.sct, assay = "SCT",    verbose = FALSE, only.pos = TRUE,  logfc.threshold = 0.35,)
head(combined.markers, n = 15)

#We produce a table with top 50 marker genes per cluster to facilitate use
combined.markers %>%
    group_by(cluster) %>%
    slice_max(n = 50, order_by = avg_log2FC)




#Following code is to produce a heatmap of the 20 top marker genes per cluster
combined.markers %>%
    group_by(cluster) %>%
    top_n(n = 20, wt = avg_log2FC) -> top20
DoHeatmap(combined.sct, features = top20$gene) + NoLegend()
```














